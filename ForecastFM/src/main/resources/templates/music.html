<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ForecastFM</title>
    <link href= "/css/style.css" rel="stylesheet" type="text/css">
</head>

<body id="music-body">
    <header>
        <img src="/images/logga.png" alt="ForecastFM logo" height="160px" width="700px">
    </header>

    <nav>
        <p><a href="/">Home</a></p>
        <p id="highlight"><a href="/music">Music today</a></p>
        <p><a href="about_us.html">About us</a></p>
    </nav>

    <main id="music-main">
        <button id="btnGenerate">Generate Music for Your Weather</button>
        <div id="status"></div>
        <div id="result"></div>
    </main>
    <script>
        const btn = document.getElementById("btnGenerate");
        const statusEl = document.getElementById("status");
        const resultEl = document.getElementById("result");

        btn.addEventListener("click", async () => {
            statusEl.textContent = "Working…";
            resultEl.innerHTML = "";

            try {
                //Hämtar geolocation genom webben, ist för genom java
                const pos = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject);
                });

                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;

                //kallar på backenden för att fixa mashupsen
                const res = await fetch(`/api/v1/mashups/weather-music?lat=${lat}&lon=${lon}`);
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`Backend error ${res.status}: ${text}`);
                }

                const data = await res.json();

                console.log("Full backend payload:", data);
                console.log("tracks raw:", data.tracks, "isArray?", Array.isArray(data.tracks));


                //renderar summeringen av datan, vädret tracks m.m.
                const weather = data.weather || {};
                const mood = data.mood || {};
                statusEl.textContent = "";

                resultEl.appendChild(renderSummary(weather, mood));
                resultEl.appendChild(renderTracks(data.tracks || []));

            } catch (err) {
                statusEl.textContent = `Request failed: ${err.message}`;
            }
        });

        function renderSummary(weather) {
            console.log("Weather icon:", weather.icon);
            const div = document.createElement("div");
            div.className = "summary";

            const city = weather.city || "—";
            const temp = weather.temperature != null ? `${weather.temperature.toFixed(1)}°C` : "—";
            const desc = weather.description || weather.main || "—";
            const icon = weather.icon
                ? `https://openweathermap.org/img/wn/${weather.icon}.png`
                : "";

            div.innerHTML = `
    <h2>Weather</h2>
    <div id="weather-info">
        <p><strong>Location:</strong> ${escapeHtml(city)}</p>
        <p><strong>Weather:</strong> ${escapeHtml(desc)} (${escapeHtml(temp)})</p>
        ${icon ? `<img src="${icon}" alt="${escapeHtml(desc)}"style="width:100px;height:100px;">` : ""}
    </div>    
  `;

            return div;
        }


        /*
        function renderTracks(tracks) {
            const section = document.createElement("section");
            section.className = "tracks";

            const title = document.createElement("h3");
            title.textContent = "Recommended tracks";
            section.appendChild(title);

            if (tracks.length === 0) {
                const p = document.createElement("p");
                p.textContent = "No tracks returned.";
                section.appendChild(p);
                return section;
            }

            const ul = document.createElement("ul");
            ul.className = "track-list";

            console.log("tracks =", tracks);
            console.log("typeof tracks =", typeof tracks, "isArray?", Array.isArray(tracks));

            tracks.forEach(t => {
                const li = document.createElement("li");
                li.className = "track-item";

                // Om backend skickar List<String>
                if (typeof t === "string") {
                    li.textContent = t;            // visar hela strängen
                    ul.appendChild(li);
                    return;
                }

                // Om backend någon gång skickar objekt (framtidssäkert)
                const name = t.name || "Unknown track";
                const artist = t.artist || "Unknown artist";
                const url = t.url || "#";
                const preview = t.previewUrl;

                li.innerHTML = `
    <a href="${url}" target="_blank" rel="noopener noreferrer">${escapeHtml(name)}</a>
    <span> – ${escapeHtml(artist)}</span>
    ${preview ? ` | <a href="${preview}" target="_blank" rel="noopener noreferrer">Preview</a>` : ""}
  `;
                ul.appendChild(li);
            });


            section.appendChild(ul);
            return section;
        }

        //XSS-skydd
        function escapeHtml(str) {
            return String(str)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }
        /*
        const output = document.getElementById("output");
        const btn = document.getElementById("btnGenerate");

        function log(msg) {
            output.textContent = msg;
        }

        btn.addEventListener("click", () => {
            log("Fetching location...");

            if (!navigator.geolocation) {
                log("Geolocation is not supported by this browser.");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;

                    log(`Got coordinates:\nlat=${lat}\nlon=${lon}\nCalling backend...`);

                    try {
                        // Din endpoint i MashupController
                        const url = `/api/v1/mashups/weather-music?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&limit=10`;

                        const res = await fetch(url);
                        if (!res.ok) {
                            const text = await res.text();
                            throw new Error(`Backend error ${res.status}: ${text}`);
                        }

                        const data = await res.json();
                        log(JSON.stringify(data, null, 2));
                    } catch (e) {
                        log(`Request failed: ${e.message}`);
                    }
                },
                (err) => {
                    log(`Could not get location (code ${err.code}): ${err.message}`);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });
         */
        function escapeHtml(str) {
            return String(str)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function renderTracks(tracks) {
            const section = document.createElement("section");
            section.className = "tracks";

            const title = document.createElement("h3");
            title.textContent = "Recommended tracks";
            section.appendChild(title);

            const list = Array.isArray(tracks) ? tracks : [];

            if (list.length === 0) {
                const p = document.createElement("p");
                p.textContent = "No tracks returned.";
                section.appendChild(p);
                return section;
            }

            const ul = document.createElement("ul");
            ul.className = "track-list";

            list.forEach(t => {
                const li = document.createElement("li");
                li.className = "track-item";
                li.textContent = String(t);
                ul.appendChild(li);
            });

            section.appendChild(ul);
            return section;
        }
        window.addEventListener("DOMContentLoaded", () => {
            const btn = document.getElementById("btnGenerate");

            if (btn) {
                btn.style.display = "none";
                btn.click();
            }
        });

    </script>
</body>
</html>