<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ForecastFM</title>
    <link href= "/css/style.css" rel="stylesheet" type="text/css">
</head>

<body id="music-body">
    <header>
        <img src="/images/logga.png" alt="ForecastFM logo" height="160px" width="700px">
    </header>

    <nav>
        <p><a href="/">Home</a></p>
        <p id="highlight"><a href="/music">Music today</a></p>
    </nav>

    <main id="music-main">

        <button id="btnGenerate">Generate Music for Your Weather</button>
        <div id="status">
            <div id="loader" class="spinner hidden"></div>
            <span id="statusText"></span>
        </div>

        <div id="result"></div>

    </main>
    <script>
        const btn = document.getElementById("btnGenerate");
        const statusTextEl = document.getElementById("statusText");
        const loaderEl = document.getElementById("loader")
        const resultEl = document.getElementById("result");

        function setLoading(isLoading, message = "") {
            if (isLoading) {
                loaderEl.classList.remove("hidden");
                statusTextEl.textContent = message;
                btn.disabled = true;
            } else {
                loaderEl.classList.add("hidden");
                btn.disabled = false;
                statusTextEl.textContent = message;
            }
        }

        btn.addEventListener("click", async () => {
            setLoading(true, "Generating...");
            resultEl.innerHTML = "";

            try {
                const pos = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject);
                });

                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;

                const res = await fetch(`/api/v1/mashup?lat=${lat}&lon=${lon}`);
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`Backend error ${res.status}: ${text}`);
                }

                const data = await res.json();

                console.log("Full backend payload:", data);
                console.log("tracks raw:", data.tracks, "isArray?", Array.isArray(data.tracks));

                const weather = data.weather || {};
                const mood = data.mood || {};

                setLoading(false, ""); // dölj spinner, rensa status
                resultEl.appendChild(renderSummary(weather, mood));
                resultEl.appendChild(renderTracks(data.tracks || []));

            } catch (err) {
                setLoading(false, `Request failed: ${err.message}`);
            }
        });

        function renderSummary(weather) {
            console.log("Weather icon:", weather.icon);
            const div = document.createElement("div");
            div.className = "summary";

            const city = weather.city || "—";
            const temp = weather.temperature != null ? `${weather.temperature.toFixed(1)}°C` : "—";
            const desc = weather.description || weather.main || "—";
            const icon = weather.icon
                ? `https://openweathermap.org/img/wn/${weather.icon}.png`
                : "";

            div.innerHTML = `
    <h2>Weather</h2>
    <div id="weather-info">
        <p><strong>Location:</strong> ${escapeHtml(city)}</p>
        <p><strong>Weather:</strong> ${escapeHtml(desc)} (${escapeHtml(temp)})</p>
        ${icon ? `<img src="${icon}" alt="${escapeHtml(desc)}"style="width:100px;height:100px;">` : ""}
    </div>    
  `;

            return div;
        }
        
        function escapeHtml(str) {
            return String(str)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function renderTracks(tracks) {
            const section = document.createElement("section");
            section.className = "tracks";

            const title = document.createElement("h3");
            title.textContent = "Recommended tracks";
            section.appendChild(title);

            const list = Array.isArray(tracks) ? tracks : [];

            if (list.length === 0) {
                const p = document.createElement("p");
                p.textContent = "No tracks returned.";
                section.appendChild(p);
                return section;
            }

            const ul = document.createElement("ul");
            ul.className = "track-list";

            list.forEach(t => {
                const li = document.createElement("li");
                li.className = "track-item";
                li.textContent = String(t);
                ul.appendChild(li);
            });

            section.appendChild(ul);
            return section;
        }
        window.addEventListener("DOMContentLoaded", () => {
            const btn = document.getElementById("btnGenerate");

            if (btn) {
                btn.style.display = "none";
                btn.click();
            }
        });

    </script>
</body>
</html>